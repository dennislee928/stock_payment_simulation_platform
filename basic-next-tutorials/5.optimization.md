# Next.js 應用程式優化與設定

本文將介紹 Next.js 應用程式開發中關於 Metadata 與 SEO、圖片優化、字體優化、指令碼優化、分析、Open Graph 圖片、草稿模式、服務整合、TypeScript 支援以及 `vercel.json` 設定等重要優化與配置概念，並包含一個使用 Mermaid 語法繪製的抽象概念圖。

## Metadata 與 SEO (Search Engine Optimization)

Next.js 提供強大的 **Metadata API** 來定義應用程式的 metadata，例如 HTML `<head>` 元素內的 `<meta>` 和 `<link>` 標籤，以提升 SEO 和網路分享能力 [1]。您可以透過以下兩種主要方式新增 metadata：

- **Config-based Metadata**：在 `layout.js` 或 `page.js` 檔案中 export 一個靜態的 `metadata` 物件或一個動態的 `generateMetadata` 函式 [1, 2]。
  - **靜態 Metadata**：您可以 export 一個 `metadata` 物件來定義標題（title）和描述（description）等靜態 metadata [1-3]。這通常在根佈局 (`layout.tsx`) 中設定網站的基本 metadata [3]。
  - **動態 Metadata**：對於需要根據動態資料（例如從 API 獲取的部落格文章標題）設定的 metadata，可以使用 `generateMetadata` 這個 async 函式 [1, 4, 5]。此函式接收 `params` 和 `searchParams` 作為參數，允許您根據路由參數或其他資料來動態產生 metadata 物件 [4]。Next.js 會自動將此物件轉換為相關的 `<meta>` 或 `<link>` 標籤 [6]。在同一個路由中的多個 segments 輸出的 `Metadata` 物件會被**淺層合併**，後面的 segment 定義的重複鍵會**取代**前面的 [7]。
- **File-based Metadata**：您可以將靜態或動態產生的特殊檔案（如 `favicon.ico`、`robots.txt`、`sitemap.xml`、`opengraph-image.jpg` 等）新增到路由 segments 中 [1]。Next.js 會自動偵測並產生相應的 meta 標籤 [8, 9]。**檔案系統 metadata 的優先權高於 config-based metadata** [8, 9]。

您可以使用 `sitemap.ts` 檔案動態生成網站地圖（sitemap）[10, 11]。這是一個 async 函式，需要設定 `return` 類型為 `Promise<MetadataRoute.Sitemap>`，並回傳一個包含網站所有頁面 URL 的陣列 [11]。同樣地，您可以使用 `robots.ts` 檔案來控制網路爬蟲的行為 [10]。

## 圖片優化 (Image Optimization)

建議使用 Next.js 提供的 `<Image>` 組件 (`next/image`) 進行圖片優化 [12, 13]。這個組件提供了許多優勢，例如：

- **優化的圖片格式**：自動提供最佳的圖片格式給使用者的瀏覽器。
- **智慧載入**：預設使用 lazy loading，僅在圖片進入可視範圍時才載入。
- **尺寸調整**：防止佈局偏移 (layout shift)。

為了使 `<Image>` 組件能夠載入來自外部來源的圖片，您需要在 `next.config.js` 檔案中配置 `images.remotePatterns` 或 `images.domains` 來列出允許的圖片來源 [12, 13]。

## 字體優化 (Font Optimization)

Next.js 也支援字體優化 [14, 15]。您可以**自託管字體**以獲得更好的效能和隱私 [14]。

## 指令碼優化 (Script Optimization)

Next.js 提供了指令碼優化策略來改善頁面載入效能 [15]。

## 分析 (Analytics)

**Vercel** 作為 Next.js 的原生平台，提供了專為 Next.js 應用程式設計的**分析功能** [13, 15]。

## Open Graph 圖片 (Open Graph Images)

Next.js 支援**動態生成 Open Graph 圖片**，讓您在社交媒體上分享連結時呈現更豐富的預覽效果 [15-19]。

## 草稿模式 (Draft Mode)

**草稿模式** 允許您在 Next.js 應用程式中預覽 Headless CMS 的**草稿內容**，而無需將其公開發布 [15, 20]。

## 服務整合 (Service Integrations)

Next.js 易於與各種服務整合，例如：

- **Sanity CMS**：一個內容管理系統 [1-4, 7, 8, 21-32]。
- **NextAuth.js (next-auth)**：用於處理使用者身份驗證 [33]。
- **`@shadcn/ui`**：一個 UI 組件庫 [28, 34]。
- **`@uiw/react-md-editor`**：一個 Markdown 編輯器組件 [5, 19]。

## TypeScript 支援

Next.js **內建支援 TypeScript**，提供靜態類型檢查，提升程式碼品質和開發效率 [1, 4, 7, 8, 35]。您可以使用 **Discriminated Unions (可辨識複合型別)** 來更精確地定義 React 組件的 props 類型 [10, 11, 19]。此外，您可以使用 **Zod** 這個 TypeScript 驗證函式庫來進行資料驗證 [36, 37]。

## `vercel.json` 設定

`vercel.json` 檔案用於**配置和覆寫 Vercel 的預設行為**，適用於您的 Next.js 專案 [37, 38]。這個檔案允許您定義各種設定，包括 [37, 39-41]：

- `buildCommand`: 定義 Vercel 構建專案時執行的命令。
- `devCommand`: 定義本地開發時執行的命令。
- `installCommand`: 定義安裝依賴套件時執行的命令。
- `outputDirectory`: 指定構建輸出的目錄。
- `public`: 指定靜態資源的公開目錄。
- `rewrites`: 定義 URL 重寫規則。
- `redirects`: 定義 URL 重定向規則。
- `headers`: 設定 HTTP 回應標頭。
- `crons`: 設定定時任務。
- `functions`: 配置 Serverless Functions。
- `images`: 設定圖片優化相關選項。
- `regions`: 指定函數部署的區域。
- `runtime`: 指定函數的運行時環境。
- `memory`: 設定函數的記憶體限制。
- `maxDuration`: 設定函數的最大執行時間。

## 抽象概念圖 (Mermaid)

以下 Mermaid 圖表說明了 Next.js 應用程式的優化與設定流程中的關鍵步驟和概念：

```mermaid
graph TD
    A[開發階段] --> B(Metadata 設定與 SEO 優化);
    A --> C(圖片優化);
    A --> D(字體優化);
    A --> E(指令碼優化);
    A --> F(TypeScript 與資料驗證);
    A --> G(服務整合);
    B --> H{準備部署};
    C --> H;
    D --> H;
    E --> H;
    F --> H;
    G --> H;
    H --> I[設定 vercel.json];
    I --> J(部署至 Vercel);
    J --> K{生產環境};
    K --> L(Vercel 分析);
    K --> M(Open Graph 圖片分享);
    K --> N(SEO 效果);
    O[草稿模式 (預覽)] --> P{內容管理系統};
    P --> A;

    style A,H,J,K fill:#f9f,stroke:#333,stroke-width:2px
    style B,C,D,E,F,G,I,L,M,N,O,P fill:#fff,stroke:#333,stroke-width:1px

圖表說明：
1.
在開發階段，開發者需要進行多方面的優化與設定。
2.
包括 Metadata 設定與 SEO 優化，確保應用程式在搜尋引擎中具有良好的可見性。
3.
圖片優化 確保圖片載入快速且有效率。
4.
字體優化 提升文字渲染效能。
5.
指令碼優化 減少不必要的 JavaScript 執行。
6.
使用 TypeScript 與資料驗證 確保程式碼的穩定性和資料的正確性。
7.
進行 服務整合，例如與 CMS 或身份驗證服務連接。
8.
在準備部署前，所有優化步驟應已完成。
9.
設定 vercel.json 以自訂 Vercel 的部署行為。
10.
最後將應用程式部署至 Vercel。
11.
在生產環境中，可以透過 Vercel 分析 監控應用程式的效能。
12.
Open Graph 圖片分享 提升社交媒體上的連結預覽效果。
13.
SEO 效果 影響應用程式的搜尋引擎排名。
14.
草稿模式 允許在開發階段預覽來自 內容管理系統 的未發布內容。
總結
透過仔細配置 Metadata 與 SEO、優化圖片和字體、管理指令碼、利用 TypeScript 和資料驗證、整合各種服務以及設定 vercel.json，您可以建構出高效能、易於維護且對搜尋引擎友善的 Next.js 應用程式。
```
