# Next.js App Router 核心概念：快取、中介層、錯誤處理、載入 UI 與串流

Next.js App Router 引入了許多增強的功能，以提供更優化的開發體驗和應用程式效能。以下將詳細介紹您提到的快取、中介層、錯誤處理以及載入 UI 與串流等核心概念，並附上 Mermaid 圖表以利理解。

## 快取 (Caching)

Next.js App Router 提供了**更細緻的快取控制** [1]。這表示開發者可以根據不同的需求，更精確地設定資料和頁面的快取策略。來源 [2] 中提到，當設定 `useCDN` 為 `true` 的 Sanity client 時，內容預設會快取 60 秒，之後會進行重新驗證（Incremental Static Regeneration, ISR）。這是一個例子，說明 Next.js 如何利用快取來提升效能。來源 [3] 也提到，Partial Prerendering (PPR) 策略中，部分內容可以設定為靜態快取一段時間（例如 60 秒使用 ISR），而其他部分則是動態渲染不快取，這進一步展現了 App Router 細緻的快取控制能力。來源 [4] 提到 Next.js 具有強大的快取機制，雖然沒有在本段詳細說明 App Router 的快取控制，但強調了其重要性。

## 中介層 (Middleware)

來源 [5] 提到了**中介層 (Middleware)**。雖然來源中並未提供關於中介層的詳細運作方式或語法，但可以理解中介層是 Next.js 應用程式請求生命週期中的一個環節，允許開發者在請求到達路由處理程序之前執行程式碼。這可以用於處理驗證、授權、重新導向、記錄等任務。

## 錯誤處理 (Error Handling)

Next.js App Router 提供了更彈性的錯誤處理機制。

- **觸發 404 錯誤**：可以使用 `notFound()` 函數來**觸發 404 錯誤** [1, 6]。當應用程式判斷請求的資源不存在時，可以呼叫 `notFound()`，Next.js 會中斷目前的渲染流程並顯示 404 頁面。來源 [7] 的程式碼範例展示了如何在伺服器組件中檢查使用者資料是否存在，如果不存在則呼叫 `notFound()`。
- **自訂 `not-found.tsx` 頁面**：開發者可以**建立自訂的 `not-found.tsx` 頁面**來呈現使用者友善的 404 錯誤訊息 [1, 8, 9]。這個檔案需要放置在 `app` 目錄或路由群組目錄中。來源 [1] 的內容詳細說明了如何建立 `not-found.tsx` 檔案，並在其中定義自訂的 404 頁面 UI，例如顯示 "The requested user does not exist" 的訊息。來源 [7] 也提到了當請求一個不存在的使用者時，會導向 Next.js 的預設 404 頁面，但強調可以建立自訂頁面來改善使用者體驗，這與來源 [1] 的說明一致。來源 [3] 中，當根據 ID 找不到貼文 (post) 時，也會 `return notFound()`，這進一步說明了 `notFound()` 的使用情境。

## 載入 UI 與串流 (Loading UI and Streaming)

Next.js App Router 藉由 `loading.tsx` 和 React 18 的 `Suspense`，以及串流技術，提供了更好的載入狀態處理和使用者體驗。

- **`loading.tsx` 建立載入狀態 UI**：在路由目錄中建立 `loading.tsx` 檔案，可以**為該路由及其子路由定義載入狀態 UI** [5]。當 Next.js 導航到這些路由並開始載入資料時，會自動顯示 `loading.tsx` 中定義的 UI。一旦資料載入完成，`loading.tsx` UI 會被實際的頁面內容替換。來源 [10] 提到，loading UIs 的運作方式與錯誤處理類似，可以在資料載入緩慢時向使用者顯示載入進度。
- **React 18 的 `Suspense` 更細粒度顯示載入狀態**：React 18 引入的 **`Suspense` 元件**允許在**更細的粒度上處理非同步操作的載入狀態** [5, 11]。開發者可以使用 `<Suspense>` 包裹可能需要時間載入的組件，並提供 `fallback` prop 來指定載入時顯示的內容。來源 [12] 說明了當靜態外殼包含動態內容的佔位符時，可以使用 `Suspense` 包裹動態組件，並在資料載入時顯示 fallback 內容。來源 [11] 在介紹 Partial Prerendering (PPR) 時也提到，可以使用 React 的 `<Suspense>` 組件來包裹動態組件，並提供 fallback 內容。
- **串流逐步發送內容，改善使用者體驗**：**串流 (Streaming)** 是一種逐步將伺服器渲染的內容發送到瀏覽器的技術 [5]。這表示瀏覽器可以更快地開始呈現頁面的部分內容，而無需等待所有資料都載入完成。結合 `Suspense`，可以在等待特定動態內容載入時，先呈現頁面的靜態部分或 fallback UI，從而**改善使用者的感知效能**。來源 [12] 和 [13] 在描述 PPR 時都提到了串流的概念，指出靜態外殼會先被提供，然後動態內容會以串流的方式逐步載入。

## 抽象概念圖 (Mermaid)

以下 Mermaid 圖表試圖說明一個請求在 Next.js App Router 中的處理流程，重點展示快取、中介層、錯誤處理和載入 UI 與串流的概念。

```mermaid
graph TD
    A[瀏覽器請求] --> B(Next.js 伺服器);

    subgraph 中介層 (Middleware)
        B --> C{符合 Middleware 規則?};
        C -- 是 --> D[執行 Middleware 程式碼];
        D --> E{繼續請求處理?};
        E -- 是 --> F;
        E -- 否 --> G[回覆瀏覽器 (可能重新導向等)];
    end

    F(路由處理) --> H{檢查快取?};
    H -- 快取命中 --> I[提供快取內容];
    H -- 快取未命中 --> J[資料獲取];
    J --> K[伺服器端渲染 (SSR/SSG/PPR)];

    subgraph 載入 UI 與串流 (Loading UI & Streaming)
        K --> L{需要載入資料的組件?};
        L -- 是 --> M[顯示 loading.tsx 或 Suspense fallback];
        M --> J;
        K --> N[逐步串流 HTML 內容至瀏覽器];
    end

    N --> O[瀏覽器呈現部分內容];
    J --> P[資料載取完成];
    P --> Q[完成伺服器端渲染];
    Q --> N;
    I --> O;

    subgraph 錯誤處理 (Error Handling)
        K -- 渲染或資料獲取失敗 --> R{判斷錯誤類型};
        R -- 404 --> S[顯示 not-found.tsx];
        R -- 其他錯誤 --> T[顯示 error.tsx (最近的父層)];
        S --> U[回覆瀏覽器 (404 錯誤)];
        T --> V[回覆瀏覽器 (錯誤訊息)];
    end

    O -- 完整內容載入 --> W[水合作用 (Hydration)];
    W --> X[互動式應用程式];
    G --> A;
    U --> A;
    V --> A;

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X fill:#fff,stroke:#333,stroke-width:1px

圖表說明：
1.
瀏覽器請求發送到 Next.js 伺服器。
2.
伺服器首先檢查是否符合中介層 (Middleware) 的規則。如果符合，則執行相關程式碼，並判斷是否繼續處理請求。
3.
請求到達路由處理階段，伺服器會檢查是否有可用的快取內容。
◦
如果快取命中，則直接提供快取內容給瀏覽器。
◦
如果快取未命中，則進行資料獲取。
4.
在伺服器端渲染階段，如果遇到需要載入資料的組件（通常使用 Suspense 包裹），可能會先顯示 loading UI 或 Suspense 的 fallback 內容。
5.
伺服器會開始逐步串流 HTML 內容到瀏覽器，讓瀏覽器可以儘早呈現部分內容。
6.
資料獲取完成後，伺服器完成渲染，並繼續串流剩餘的內容。
7.
瀏覽器接收到完整的內容後進行水合作用 (Hydration)，使頁面具有互動性。
8.
如果在渲染或資料獲取過程中發生錯誤，伺服器會判斷錯誤類型。
◦
如果是 404 錯誤，則顯示自訂的 not-found.tsx 頁面。
◦
如果是其他錯誤，則顯示最近父層級的 error.tsx 錯誤處理頁面。
9.
中介層、錯誤處理階段也可能直接回覆瀏覽器。
這個圖表旨在提供一個高層次的抽象理解，說明這些核心概念如何在 Next.js App Router 的請求處理流程中協同運作，以提供高效能和良好的使用者體驗。
```
