import{n as e,a as t,B as r,d as c,r as a,c as o,u as i}from"../../../nitro/nitro.mjs";const p=globalThis.crypto?.subtle,getRandomValues=e=>globalThis.crypto?.getRandomValues(e),y=new Proxy(globalThis.crypto,{get:(e,t)=>"CryptoKey"===t?globalThis.CryptoKey:"function"==typeof globalThis.crypto[t]?globalThis.crypto[t].bind(globalThis.crypto):globalThis.crypto[t]}),randomBytes=(e,t)=>{const c=r.alloc(e,0,void 0);for(let t=0;t<e;t+=65536)getRandomValues(Uint8Array.prototype.subarray.call(c,t,t+65536));if("function"!=typeof t)return c;t(null,c)},_=randomBytes,n=randomBytes,S=e("crypto.checkPrime"),s=e("crypto.checkPrimeSync"),E=e("crypto.pseudoRandomBytes"),l=e("crypto.createCipheriv"),O=e("crypto.createDecipheriv"),N=e("crypto.createDiffieHellman"),m=e("crypto.createDiffieHellmanGroup"),d=e("crypto.createECDH"),h=e("crypto.createHash"),P=e("crypto.createHmac"),u=e("crypto.createPrivateKey"),T=e("crypto.createPublicKey"),C=e("crypto.createSecretKey"),D=e("crypto.createSign"),f=e("crypto.createVerify"),I=e("crypto.diffieHellman"),H=e("crypto.generatePrime"),L=e("crypto.generatePrimeSync"),R=e("crypto.getCiphers"),g=e("crypto.getCipherInfo"),A=e("crypto.getCurves"),M=e("crypto.getDiffieHellman"),b=e("crypto.getHashes"),G=e("crypto.hkdf"),K=e("crypto.hkdfSync"),v=e("crypto.pbkdf2"),U=e("crypto.pbkdf2Sync"),V=e("crypto.generateKeyPair"),k=e("crypto.generateKeyPairSync"),w=e("crypto.generateKey"),$=e("crypto.generateKeySync"),B=e("crypto.privateDecrypt"),F=e("crypto.privateEncrypt"),Y=e("crypto.publicDecrypt"),j=e("crypto.publicEncrypt"),X=e("crypto.randomFill"),x=e("crypto.randomFillSync"),q=e("crypto.randomInt"),W=e("crypto.scrypt"),Z=e("crypto.scryptSync"),Q=e("crypto.sign"),z=e("crypto.setEngine"),J=e("crypto.timingSafeEqual"),ee=e("crypto.getFips"),te=e("crypto.setFips"),re=e("crypto.verify"),ce=e("crypto.secureHeapUsed"),ae=e("crypto.hash"),oe={constants:{OPENSSL_VERSION_NUMBER:0,SSL_OP_ALL:2147485776,SSL_OP_ALLOW_NO_DHE_KEX:1024,SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION:262144,SSL_OP_CIPHER_SERVER_PREFERENCE:4194304,SSL_OP_CISCO_ANYCONNECT:32768,SSL_OP_COOKIE_EXCHANGE:8192,SSL_OP_CRYPTOPRO_TLSEXT_BUG:2147483648,SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS:2048,SSL_OP_LEGACY_SERVER_CONNECT:4,SSL_OP_NO_COMPRESSION:131072,SSL_OP_NO_ENCRYPT_THEN_MAC:524288,SSL_OP_NO_QUERY_MTU:4096,SSL_OP_NO_RENEGOTIATION:1073741824,SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION:65536,SSL_OP_NO_SSLv2:0,SSL_OP_NO_SSLv3:33554432,SSL_OP_NO_TICKET:16384,SSL_OP_NO_TLSv1:67108864,SSL_OP_NO_TLSv1_1:268435456,SSL_OP_NO_TLSv1_2:134217728,SSL_OP_NO_TLSv1_3:536870912,SSL_OP_PRIORITIZE_CHACHA:2097152,SSL_OP_TLS_ROLLBACK_BUG:8388608,ENGINE_METHOD_RSA:1,ENGINE_METHOD_DSA:2,ENGINE_METHOD_DH:4,ENGINE_METHOD_RAND:8,ENGINE_METHOD_EC:2048,ENGINE_METHOD_CIPHERS:64,ENGINE_METHOD_DIGESTS:128,ENGINE_METHOD_PKEY_METHS:512,ENGINE_METHOD_PKEY_ASN1_METHS:1024,ENGINE_METHOD_ALL:65535,ENGINE_METHOD_NONE:0,DH_CHECK_P_NOT_SAFE_PRIME:2,DH_CHECK_P_NOT_PRIME:1,DH_UNABLE_TO_CHECK_GENERATOR:4,DH_NOT_SUITABLE_GENERATOR:8,RSA_PKCS1_PADDING:1,RSA_NO_PADDING:3,RSA_PKCS1_OAEP_PADDING:4,RSA_X931_PADDING:5,RSA_PKCS1_PSS_PADDING:6,RSA_PSS_SALTLEN_DIGEST:-1,RSA_PSS_SALTLEN_MAX_SIGN:-2,RSA_PSS_SALTLEN_AUTO:-2,defaultCoreCipherList:"",TLS1_VERSION:0,TLS1_1_VERSION:0,TLS1_2_VERSION:0,TLS1_3_VERSION:0,POINT_CONVERSION_COMPRESSED:2,POINT_CONVERSION_UNCOMPRESSED:4,POINT_CONVERSION_HYBRID:6,defaultCipherList:""},getRandomValues:getRandomValues,randomUUID:()=>globalThis.crypto?.randomUUID(),subtle:p,Certificate:t("crypto.Certificate"),Cipher:t("crypto.Cipher"),Cipheriv:t("crypto.Cipheriv"),Decipher:t("crypto.Decipher"),Decipheriv:t("crypto.Decipheriv"),DiffieHellman:t("crypto.DiffieHellman"),DiffieHellmanGroup:t("crypto.DiffieHellmanGroup"),ECDH:t("crypto.ECDH"),Hash:t("crypto.Hash"),Hmac:t("crypto.Hmac"),KeyObject:t("crypto.KeyObject"),Sign:t("crypto.Sign"),Verify:t("crypto.Verify"),X509Certificate:t("crypto.X509Certificate"),checkPrime:S,checkPrimeSync:s,createCipheriv:l,createDecipheriv:O,createDiffieHellman:N,createDiffieHellmanGroup:m,createECDH:d,createHash:h,createHmac:P,createPrivateKey:u,createPublicKey:T,createSecretKey:C,createSign:D,createVerify:f,diffieHellman:I,fips:!1,generateKey:w,generateKeyPair:V,generateKeyPairSync:k,generateKeySync:$,generatePrime:H,generatePrimeSync:L,getCipherInfo:g,getCiphers:R,getCurves:A,getDiffieHellman:M,getFips:ee,getHashes:b,hash:ae,hkdf:G,hkdfSync:K,pbkdf2:v,pbkdf2Sync:U,privateDecrypt:B,privateEncrypt:F,pseudoRandomBytes:E,publicDecrypt:Y,prng:n,publicEncrypt:j,randomBytes:randomBytes,randomFill:X,randomFillSync:x,randomInt:q,rng:_,scrypt:W,scryptSync:Z,secureHeapUsed:ce,setEngine:z,setFips:te,sign:Q,timingSafeEqual:J,verify:re,webcrypto:y},ie=c((async e=>{const t=await a(e);if(!(t&&t.items&&t.totalAmount&&t.contact))throw o({statusCode:400,statusMessage:"缺少必要的訂單資訊"});if(!t.paymentMethod||!t.items||!t.contactInfo)throw o({statusCode:400,statusMessage:"缺少必要欄位"});if(!["ecpay","creditcard"].includes(t.paymentMethod))throw o({statusCode:400,statusMessage:"不支援的支付方式"});const r=`ORD${Date.now()}${Math.floor(1e3*Math.random())}`,c=i(),p=c.public.ecpayMerchantId,y=c.public.ecpayHashKey,_=c.public.ecpayHashIV;let n=0;for(const e of t.items)n+=e.price*e.quantity;let S="";if("ecpay"===t.paymentMethod){Date.now();t.items.map((e=>e.symbol)).join(", "),S=`https://payment-simulation.example.com/ecpay?orderId=${r}&amount=${n}`}else if("creditcard"===t.paymentMethod){const e=t.paymentDetails||{};if(!e.cardNumber||!e.expiryDate||!e.cvv)throw o({statusCode:400,statusMessage:"信用卡資訊不完整"});Date.now();e.cardNumber.slice(-4),Math.round(.02*n),S=""}(new Date).toISOString(),t.paymentMethod,t.paymentMethod,t.items,t.contactInfo;let s={MerchantID:p,MerchantTradeNo:r,MerchantTradeDate:(new Date).toISOString().replace(/[-T:.Z]/g,"").substring(0,14),PaymentType:"aio",TotalAmount:t.totalAmount.toString(),TradeDesc:`股票模擬購買_${r}`,ItemName:t.items.map((e=>`${e.symbol}_${e.name}`)).join("#"),ReturnURL:"https://your-production-domain.com/api/payment/callback",ChoosePayment:mapPaymentMethod(t.paymentMethod),ClientBackURL:`https://your-production-domain.com/result?orderId=${r}`,OrderResultURL:`https://your-production-domain.com/result?orderId=${r}`,EncryptType:"1"};const E=function(e,t,r){const c=Object.keys(e).sort().reduce(((t,r)=>(t[r]=e[r],t)),{}),a=Object.entries(c).map((([e,t])=>`${e}=${t}`)).join("&"),o=`HashKey=${t}&${a}&HashIV=${r}`,i=encodeURIComponent(o).replace(/%20/g,"+").toLowerCase(),p=oe.createHash("sha256").update(i).digest("hex").toUpperCase();return{...c,CheckMacValue:p}}(s,y,_);return{success:!0,orderId:r,redirectUrl:S||null,formData:{...s,CheckMacValue:E.CheckMacValue}}}));function mapPaymentMethod(e){switch(e){case"credit_card":default:return"Credit";case"atm":return"ATM";case"cvs":return"CVS"}}export{ie as default};
//# sourceMappingURL=submit.post.mjs.map
